{% extends "base.html" %}
{% block title %}{% block page_title %}Admin Panel{% endblock %} - Sistem Pakar Padi{% endblock %}

{% block extra_css %}{% endblock %}
{% block extra_css_links %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}?v=20260213-admin-v2">
{% endblock %}

{% block body %}
<div class="admin-shell" id="adminShell">
    <div class="admin-overlay" id="adminOverlay"></div>

    <aside class="admin-sidebar" id="adminSidebar" aria-label="Sidebar navigation">
        <div class="admin-sidebar-head">
            <div class="admin-sidebar-brand">
                <span class="brand-icon"><i class="fas fa-seedling"></i></span>
                <div class="brand-text">
                    <strong>Pakar Padi</strong>
                    <small>Admin Panel</small>
                </div>
            </div>
            <button type="button" class="admin-icon-btn d-none d-lg-inline-flex" id="sidebarToggleDesktop" aria-label="Collapse sidebar" title="Collapse sidebar">
                <i class="fas fa-chevron-left" id="sidebarToggleDesktopIcon"></i>
            </button>
            <button type="button" class="admin-icon-btn d-lg-none" id="sidebarCloseMobile" aria-label="Close sidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <nav class="admin-sidebar-nav">
            <a class="nav-link {% if request.path == '/admin/dashboard' or request.path == '/admin/dashboard/' %}active{% endif %}" href="/admin/dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a class="nav-link {% if 'penyakit' in request.path %}active{% endif %}" href="/admin/penyakit">
                <i class="fas fa-virus"></i>
                <span>Kelola Penyakit</span>
            </a>
            <a class="nav-link {% if 'gejala' in request.path %}active{% endif %}" href="/admin/gejala">
                <i class="fas fa-stethoscope"></i>
                <span>Kelola Gejala</span>
            </a>
            <a class="nav-link {% if 'rule' in request.path and 'rules' not in request.path %}active{% endif %}" href="/admin/rule">
                <i class="fas fa-sitemap"></i>
                <span>Kelola Rule</span>
            </a>

            <div class="nav-divider"></div>

            <a class="nav-link {% if 'pengguna' in request.path %}active{% endif %}" href="/admin/pengguna">
                <i class="fas fa-users"></i>
                <span>Data Pengguna</span>
            </a>
            <a class="nav-link {% if 'riwayat' in request.path %}active{% endif %}" href="/admin/riwayat">
                <i class="fas fa-history"></i>
                <span>Riwayat Diagnosis</span>
            </a>
            <a class="nav-link {% if 'laporan' in request.path %}active{% endif %}" href="/admin/laporan">
                <i class="fas fa-chart-bar"></i>
                <span>Laporan</span>
            </a>

            <div class="nav-divider"></div>

            <a class="nav-link {% if 'pengaturan-sistem' in request.path %}active{% endif %}" href="/admin/pengaturan-sistem">
                <i class="fas fa-cogs"></i>
                <span>Pengaturan Sistem</span>
            </a>
            <a class="nav-link {% if 'logs' in request.path %}active{% endif %}" href="/admin/logs">
                <i class="fas fa-clipboard-list"></i>
                <span>System Logs</span>
            </a>
            <a class="nav-link {% if request.path == '/admin/pengaturan' or request.path == '/admin/pengaturan/' %}active{% endif %}" href="/admin/pengaturan">
                <i class="fas fa-user-cog"></i>
                <span>Pengaturan Admin</span>
            </a>
        </nav>

        <div class="admin-sidebar-footer">
            <a class="nav-link logout-link" href="{{ url_for('admin.admin_auth.logout') }}">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <main class="admin-main" id="adminMain">
        <header class="admin-topbar">
            <div class="admin-topbar-left">
                <button type="button" class="admin-icon-btn d-lg-none" id="sidebarToggleMobile" aria-label="Open sidebar">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="admin-page-meta">
                    <h1>
                        <i class="fas fa-{% block page_icon %}chart-line{% endblock %} me-2"></i>
                        {% block page_title_header %}Admin Panel{% endblock %}
                    </h1>
                    <p>Kelola data sistem secara terpusat, cepat, dan aman.</p>
                </div>
            </div>

            <div class="admin-topbar-right">
                <div class="admin-user-chip">
                    <i class="fas fa-user-circle"></i>
                    <span>{{ session.get('admin_name', 'Administrator') }}</span>
                </div>
            </div>
        </header>

        <section class="admin-main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% block admin_content %}{% endblock %}
        </section>
    </main>
</div>

<script>
(function () {
    const desktopKey = 'admin_sidebar_collapsed';
    const overlay = document.getElementById('adminOverlay');
    const btnDesktop = document.getElementById('sidebarToggleDesktop');
    const desktopIcon = document.getElementById('sidebarToggleDesktopIcon');
    const btnMobile = document.getElementById('sidebarToggleMobile');
    const btnCloseMobile = document.getElementById('sidebarCloseMobile');
    const navLinks = document.querySelectorAll('.admin-sidebar-nav .nav-link');

    const updateDesktopToggleVisual = (collapsed) => {
        if (!desktopIcon || !btnDesktop) return;

        desktopIcon.classList.remove('fa-chevron-left', 'fa-chevron-right');
        desktopIcon.classList.add(collapsed ? 'fa-chevron-right' : 'fa-chevron-left');

        const label = collapsed ? 'Open sidebar' : 'Collapse sidebar';
        btnDesktop.setAttribute('aria-label', label);
        btnDesktop.setAttribute('title', label);
    };

    const applyDesktopState = (collapsed) => {
        if (collapsed) {
            document.body.classList.add('admin-sidebar-collapsed');
        } else {
            document.body.classList.remove('admin-sidebar-collapsed');
        }
        updateDesktopToggleVisual(collapsed);
        localStorage.setItem(desktopKey, collapsed ? '1' : '0');
    };

    const closeMobileSidebar = () => {
        document.body.classList.remove('admin-mobile-open');
    };

    const openMobileSidebar = () => {
        document.body.classList.add('admin-mobile-open');
    };

    if (window.innerWidth >= 992) {
        const persisted = localStorage.getItem(desktopKey) === '1';
        applyDesktopState(persisted);
    }

    btnDesktop?.addEventListener('click', () => {
        const isCollapsed = document.body.classList.contains('admin-sidebar-collapsed');
        applyDesktopState(!isCollapsed);
    });

    btnMobile?.addEventListener('click', openMobileSidebar);
    btnCloseMobile?.addEventListener('click', closeMobileSidebar);
    overlay?.addEventListener('click', closeMobileSidebar);

    navLinks.forEach((link) => {
        link.addEventListener('click', () => {
            if (window.innerWidth < 992) {
                closeMobileSidebar();
                return;
            }

            // Saat sidebar collapsed dan user klik icon menu,
            // otomatis buka sidebar agar menu aktif terlihat jelas.
            if (document.body.classList.contains('admin-sidebar-collapsed')) {
                applyDesktopState(false);
            }
        });
    });
})();

// Session management - force logout when browser closes and reopens
(function() {
    const BROWSER_SESSION_KEY = 'admin_browser_session';
    const hasServerSession = document.cookie.split(';').some(c => c.trim().startsWith('admin_session='));

    if (hasServerSession) {
        const browserSession = sessionStorage.getItem(BROWSER_SESSION_KEY);
        if (!browserSession) {
            window.location.href = '/admin/logout';
        }
    } else {
        sessionStorage.setItem(BROWSER_SESSION_KEY, Date.now());
    }

    sessionStorage.setItem(BROWSER_SESSION_KEY, Date.now());
})();
</script>
{% endblock %}

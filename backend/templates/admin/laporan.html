{% extends "admin/layout.html" %}
{% block page_title %}Laporan & Statistik{% endblock %}
{% block page_title_header %}Laporan & Statistik{% endblock %}
{% block page_icon %}chart-bar{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-2">
                        <i class="fas fa-chart-bar me-2 text-primary"></i>
                        Laporan & Statistik
                    </h2>
                    <p class="text-muted mb-0">Analisis data diagnosis sistem</p>
                </div>
                <div>
                    <button class="btn btn-success me-2" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-2"></i>Export Excel
                    </button>
                    <button class="btn btn-danger" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf me-2"></i>Export PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stat-card">
                <h5 class="mb-3">
                    <i class="fas fa-filter me-2"></i>
                    Filter Periode
                </h5>
                <form id="filterForm" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="startDate" class="form-label">Tanggal Mulai</label>
                        <input type="date" class="form-control" id="startDate" name="start_date">
                    </div>
                    <div class="col-md-4">
                        <label for="endDate" class="form-label">Tanggal Akhir</label>
                        <input type="date" class="form-control" id="endDate" name="end_date">
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i>Terapkan
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetFilter()">
                            <i class="fas fa-redo me-1"></i>Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Stat Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card" style="border-left: 4px solid #3b82f6;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1" style="font-size: 0.9rem;">Total Diagnosis</p>
                        <h3 class="mb-0 fw-bold" id="totalDiagnoses">0</h3>
                        <small class="text-primary">Periode ini</small>
                    </div>
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-clipboard-list fa-2x text-white"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="border-left: 4px solid #16a34a;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1" style="font-size: 0.9rem;">Penyakit Terbanyak</p>
                        <h6 class="mb-0 fw-bold" id="topDiseaseName">-</h6>
                        <small class="text-success"><span id="topDiseaseCount">0</span> kasus</small>
                    </div>
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #16a34a, #15803d); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-virus fa-2x text-white"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="border-left: 4px solid #0ea5e9;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1" style="font-size: 0.9rem;">User Teraktif</p>
                        <h6 class="mb-0 fw-bold" id="topUserEmail" style="font-size: 0.85rem;">-</h6>
                        <small class="text-info"><span id="topUserCount">0</span> diagnosis</small>
                    </div>
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #0ea5e9, #0284c7); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-check fa-2x text-white"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="border-left: 4px solid #f59e0b;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1" style="font-size: 0.9rem;">Avg. Confidence</p>
                        <h3 class="mb-0 fw-bold" id="avgConfidence">0%</h3>
                        <small class="text-warning">Rata-rata</small>
                    </div>
                    <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-percent fa-2x text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <!-- Line Chart: Diagnosis per hari -->
        <div class="col-md-12 mb-4">
            <div class="stat-card">
                <h5 class="mb-4">
                    <i class="fas fa-chart-line me-2 text-primary"></i>
                    Diagnosis per Hari
                </h5>
                <div style="position: relative; height: 300px;">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Pie Chart: Top 5 Penyakit -->
        <div class="col-md-6 mb-4">
            <div class="stat-card">
                <h5 class="mb-4">
                    <i class="fas fa-chart-pie me-2 text-success"></i>
                    Top 5 Penyakit
                </h5>
                <div style="position: relative; height: 300px;">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Bar Chart: Diagnosis by Method -->
        <div class="col-md-6 mb-4">
            <div class="stat-card">
                <h5 class="mb-4">
                    <i class="fas fa-chart-bar me-2 text-info"></i>
                    Diagnosis Berdasarkan Metode
                </h5>
                <div style="position: relative; height: 300px;">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<!-- Include jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Include xlsx -->
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

<script>
let lineChartInstance = null;
let pieChartInstance = null;
let barChartInstance = null;

// Set default date range (last 30 days)
function setDefaultDateRange() {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);

    document.getElementById('endDate').valueAsDate = endDate;
    document.getElementById('startDate').valueAsDate = startDate;
}

// Get current filter values
function getFilterParams() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    return { start_date: startDate, end_date: endDate };
}

// Load all data
async function loadAllData() {
    const params = getFilterParams();
    const queryString = new URLSearchParams(params).toString();

    try {
        // Show loading state
        showLoading();

        // Fetch all data in parallel
        const [statsData, dailyData, diseaseData, methodData] = await Promise.all([
            fetch(`/admin/laporan/statistics?${queryString}`).then(r => r.json()),
            fetch(`/admin/laporan/chart-diagnosis-daily?${queryString}`).then(r => r.json()),
            fetch(`/admin/laporan/chart-disease-distribution?${queryString}`).then(r => r.json()),
            fetch(`/admin/laporan/chart-method-distribution?${queryString}`).then(r => r.json())
        ]);

        // Update stat cards
        if (statsData.success) {
            updateStatCards(statsData.data);
        }

        // Update charts
        if (dailyData.success) {
            updateLineChart(dailyData.data);
        }
        if (diseaseData.success) {
            updatePieChart(diseaseData.data);
        }
        if (methodData.success) {
            updateBarChart(methodData.data);
        }

        hideLoading();
    } catch (error) {
        console.error('Error loading data:', error);
        showToast('Gagal memuat data', 'error');
        hideLoading();
    }
}

// Update stat cards
function updateStatCards(data) {
    document.getElementById('totalDiagnoses').textContent = data.total_diagnoses || 0;
    document.getElementById('topDiseaseName').textContent = data.most_common_disease.name || 'N/A';
    document.getElementById('topDiseaseCount').textContent = data.most_common_disease.count || 0;
    document.getElementById('topUserEmail').textContent = data.most_active_user.email || 'N/A';
    document.getElementById('topUserCount').textContent = data.most_active_user.count || 0;

    const avgConf = (data.avg_confidence * 100).toFixed(1);
    document.getElementById('avgConfidence').textContent = avgConf + '%';
}

// Update Line Chart
function updateLineChart(data) {
    const ctx = document.getElementById('lineChart').getContext('2d');

    if (lineChartInstance) {
        lineChartInstance.destroy();
    }

    lineChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Jumlah Diagnosis',
                data: data.values,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Update Pie Chart
function updatePieChart(data) {
    const ctx = document.getElementById('pieChart').getContext('2d');

    if (pieChartInstance) {
        pieChartInstance.destroy();
    }

    const colors = [
        '#16a34a', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'
    ];

    pieChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.labels,
            datasets: [{
                data: data.values,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 15,
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Update Bar Chart
function updateBarChart(data) {
    const ctx = document.getElementById('barChart').getContext('2d');

    if (barChartInstance) {
        barChartInstance.destroy();
    }

    barChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Jumlah Diagnosis',
                data: data.values,
                backgroundColor: ['#16a34a', '#3b82f6', '#f59e0b'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Export to PDF
async function exportToPDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const params = getFilterParams();
        const startDate = params.start_date || 'N/A';
        const endDate = params.end_date || 'N/A';

        // Title
        doc.setFontSize(18);
        doc.text('Laporan Diagnosis Sistem Pakar Padi', 14, 20);

        // Period
        doc.setFontSize(11);
        doc.text(`Periode: ${startDate} s/d ${endDate}`, 14, 30);

        // Stats
        doc.setFontSize(12);
        doc.text('Statistik:', 14, 40);
        doc.setFontSize(10);

        const totalDiag = document.getElementById('totalDiagnoses').textContent;
        const topDisease = document.getElementById('topDiseaseName').textContent;
        const topDiseaseCount = document.getElementById('topDiseaseCount').textContent;
        const topUser = document.getElementById('topUserEmail').textContent;
        const topUserCount = document.getElementById('topUserCount').textContent;
        const avgConf = document.getElementById('avgConfidence').textContent;

        doc.text(`Total Diagnosis: ${totalDiag}`, 14, 48);
        doc.text(`Penyakit Terbanyak: ${topDisease} (${topDiseaseCount} kasus)`, 14, 56);
        doc.text(`User Teraktif: ${topUser} (${topUserCount} diagnosis)`, 14, 64);
        doc.text(`Avg. Confidence Score: ${avgConf}`, 14, 72);

        // Charts as images
        if (lineChartInstance) {
            const lineImg = lineChartInstance.toBase64Image();
            doc.addPage();
            doc.setFontSize(12);
            doc.text('Diagnosis per Hari', 14, 20);
            doc.addImage(lineImg, 'PNG', 14, 30, 180, 100);
        }

        if (pieChartInstance) {
            doc.addPage();
            doc.setFontSize(12);
            doc.text('Top 5 Penyakit', 14, 20);
            const pieImg = pieChartInstance.toBase64Image();
            doc.addImage(pieImg, 'PNG', 40, 30, 130, 130);
        }

        if (barChartInstance) {
            doc.addPage();
            doc.setFontSize(12);
            doc.text('Diagnosis Berdasarkan Metode', 14, 20);
            const barImg = barChartInstance.toBase64Image();
            doc.addImage(barImg, 'PNG', 14, 30, 180, 100);
        }

        doc.save(`laporan_${startDate}_${endDate}.pdf`);
        showToast('PDF berhasil diexport', 'success');
    } catch (error) {
        console.error('Error exporting PDF:', error);
        showToast('Gagal export PDF', 'error');
    }
}

// Export to Excel
async function exportToExcel() {
    try {
        const params = getFilterParams();
        const queryString = new URLSearchParams(params).toString();

        // Fetch detailed data for Excel
        const [statsData, dailyData, diseaseData, methodData] = await Promise.all([
            fetch(`/admin/laporan/statistics?${queryString}`).then(r => r.json()),
            fetch(`/admin/laporan/chart-diagnosis-daily?${queryString}`).then(r => r.json()),
            fetch(`/admin/laporan/chart-disease-distribution?${queryString}`).then(r => r.json()),
            fetch(`/admin/laporan/chart-method-distribution?${queryString}`).then(r => r.json())
        ]);

        // Create workbook
        const wb = XLSX.utils.book_new();

        // Sheet 1: Summary
        const summaryData = [
            ['Laporan Diagnosis Sistem Pakar Padi'],
            [`Periode: ${params.start_date} s/d ${params.end_date}`],
            [],
            ['Statistik Ringkasan'],
            ['Total Diagnosis', statsData.data.total_diagnoses],
            ['Penyakit Terbanyak', statsData.data.most_common_disease.name],
            ['Jumlah Kasus', statsData.data.most_common_disease.count],
            ['User Teraktif', statsData.data.most_active_user.email],
            ['Jumlah Diagnosis', statsData.data.most_active_user.count],
            ['Avg. Confidence', (statsData.data.avg_confidence * 100).toFixed(2) + '%']
        ];
        const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, ws1, 'Ringkasan');

        // Sheet 2: Daily Data
        if (dailyData.success) {
            const dailyRows = [['Tanggal', 'Jumlah Diagnosis']];
            dailyData.data.labels.forEach((label, i) => {
                dailyRows.push([label, dailyData.data.values[i]]);
            });
            const ws2 = XLSX.utils.aoa_to_sheet(dailyRows);
            XLSX.utils.book_append_sheet(wb, ws2, 'Data Harian');
        }

        // Sheet 3: Disease Distribution
        if (diseaseData.success) {
            const diseaseRows = [['Penyakit', 'Jumlah Kasus']];
            diseaseData.data.labels.forEach((label, i) => {
                diseaseRows.push([label, diseaseData.data.values[i]]);
            });
            const ws3 = XLSX.utils.aoa_to_sheet(diseaseRows);
            XLSX.utils.book_append_sheet(wb, ws3, 'Distribusi Penyakit');
        }

        // Sheet 4: Method Distribution
        if (methodData.success) {
            const methodRows = [['Metode', 'Jumlah Diagnosis']];
            methodData.data.labels.forEach((label, i) => {
                methodRows.push([label, methodData.data.values[i]]);
            });
            const ws4 = XLSX.utils.aoa_to_sheet(methodRows);
            XLSX.utils.book_append_sheet(wb, ws4, 'Metode Diagnosis');
        }

        // Download
        XLSX.writeFile(wb, `laporan_${params.start_date}_${params.end_date}.xlsx`);
        showToast('Excel berhasil diexport', 'success');
    } catch (error) {
        console.error('Error exporting Excel:', error);
        showToast('Gagal export Excel', 'error');
    }
}

// Reset filter
function resetFilter() {
    setDefaultDateRange();
    loadAllData();
}

// Form submit handler
document.getElementById('filterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    loadAllData();
});

// Toast notification
function showToast(message, type = 'info') {
    alert(message); // Simple alert, you can replace with better toast library
}

// Loading state
function showLoading() {
    // Add loading spinner or overlay
    console.log('Loading...');
}

function hideLoading() {
    console.log('Loading complete');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    setDefaultDateRange();
    loadAllData();
});
</script>
{% endblock %}
